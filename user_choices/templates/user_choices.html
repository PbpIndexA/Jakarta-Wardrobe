{% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <title>User Choices Page</title>
  </head>
  {% include "navbar.html" %}
  <body class="bg-gray-100 flex flex-col min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold text-center mb-8">User Choices Page</h1>
      <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <!-- Products will be dynamically added here -->
      </div>
    </div>
  </body>
</html>

<script>
  // Fetch the product data from the /json/ endpoint
  fetch('json')
    .then(response => response.json())
    .then(data => {
      const productList = document.getElementById('product-list');

      // Loop through the data and create product elements
      data.forEach(product => {
        // Create a div element for each product
        const productDiv = document.createElement('div');
        productDiv.classList.add('bg-white', 'shadow-md', 'rounded-lg', 'overflow-hidden');

        // Create the product content
        productDiv.innerHTML = `
          <img src="${product.img_url}" alt="${product.name}" class="w-full h-48 object-cover">
          <div class="p-4">
            <h2 class="text-xl font-bold">${product.name}</h2>
            <p class="text-gray-600">${product.category}</p>
            <p class="text-gray-800 font-semibold">Rp${product.price}</p>
            <p class="text-gray-600">${product.desc}</p>
            <p class="text-gray-600">Color: ${product.color}</p>
            <p class="text-gray-600">Stock: ${product.stock}</p>
            <p class="text-gray-600">Shop: ${product.shop_name}</p>
            <p class="text-gray-600">Location: ${product.location}</p>
            <button id="love-btn-${product.pk}" 
                    onclick="toggleChoice('${product.pk}')" 
                    value="addded"  
                    class="mt-4 bg-red-500 text-white px-4 py-2 rounded">
              ‚ù§Ô∏è Add to Wishlist
            </button>
          </div>
        `;

        // Append the product div to the product list
        productList.appendChild(productDiv);
      });
    })
    .catch(error => {
      console.error('Error fetching product data:', error);
    });

  function toggleChoice(itemId) {
    const button = document.getElementById('love-btn-' + itemId);
    const isAdding = button.value === 'add';

    const url = isAdding ? `/user_choices/add_user_choices/${itemId}` : `/user_choices/delete_user_choices/${itemId}`;
    const method = isAdding ? 'POST' : 'DELETE';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'  // Ensure CSRF token is set up
      },
      body: JSON.stringify({ choice: itemId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        if (isAdding) {
          button.value = 'remove';
          button.innerHTML = 'üíî Remove from Wishlist';
        } else {
          button.value = 'add';
          button.innerHTML = '‚ù§Ô∏è Add to Wishlist';
        }
        alert(data.message);
      } else {
        alert(data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("An error occurred while processing your request.");
    });
  }
</script>
{% endblock content %}
